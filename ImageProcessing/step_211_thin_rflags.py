#!/usr/local/bin/python3.8
#
# NB: We strive to use y-x coordinate order to match numpy's convention

''' STEP 210: Locate And-ish, Or-ish and Inverter-ish elements '''

import sys

import numpy as np

import templates

FLAG_ISH_50 = '''
-------------------------
-                  ------
- ################  -----
- #--------------##  ----
- #---------------##  ---
- #----------------##  --
- #-----------------## --
  #------------------##  
- #-----------------## --
- #----------------## ---
- #---------------## ----
- #--------------## -----
- ################ ------
-                 -------
-------------------------
'''

FLAG_ISH_SCAN = '''
---------------------------------------------------------------------------------------------------------------------------
-------------- ------------------------------------------------------------------------------------------------------------
---------          --------------------------------------------------------------------------------------------------------
--------                                                                                     ------------------------------
------                                                                                          ---------------------------
-----                                                                                             -------------------------
----                                                                                               ------------------------
----                                                                                                -----------------------
---       ##########    ##  ###################################### ########################          ----------------------
---       ####################################################################################        ---------------------
---      ######################################################################################        --------------------
---      #######################################################################################        -------------------
--       ########################################################################################        ------------------
--      ###########                                                                      #########        -----------------
--      #########                                                                           #######        ----------------
--      ########                                                                             #######        ---------------
--      ########                                                                              #######        --------------
--      #######                                                                                #######         ------------
--      #######                                   - -  ---  -   -    - -  ---- -  -             #######         -----------
--      #######         ----------------------------------------------------------------         #######         ----------
--      #######        ------------------------------------------------------------------         #######         ---------
--      #######       ---------------------------------------------------------------------         ######         --------
--      #######       ---------------------------------------------------------------------         #######         -------
--      #######      -----------------------------------------------------------------------         #######         ------
--      #######      -------------------------------------------------------------------------        #######         -----
--      #######      --------------------------------------------------------------------------        #######        -----
--      #######      ---------------------------------------------------------------------------        #######        ----
        #######      ----------------------------------------------------------------------------        #######        ---
        #######      -----------------------------------------------------------------------------        #######        --
        #######      -----------------------------------------------------------------------------         #######        -
        #######      -------------------------------------------------------------------------------        #######        
        #######      --------------------------------------------------------------------------------        #######       
        #######      --------------------------------------------------------------------------------         #######      
        #######      ---------------------------------------------------------------------------------        ########     
        #######      ----------------------------------------------------------------------------------        ########    
        #######      ----------------------------------------------------------------------------------         ########   
        #######      ----------------------------------------------------------------------------------         ########   
        #######      -----------------------------------------------------------------------------------        ########   
        #######      -----------------------------------------------------------------------------------        ########   
        #######      ----------------------------------------------------------------------------------         ########   
        #######      ---------------------------------------------------------------------------------          #######    
        #######      ---------------------------------------------------------------------------------         ######      
        #######      --------------------------------------------------------------------------------         ######       
        #######      -------------------------------------------------------------------------------         ######        
        #######      ------------------------------------------------------------------------------         ######         
        #######      ------------------------------------------------------------------------------        ######         -
        #######      -----------------------------------------------------------------------------        ######         --
-        ######      ----------------------------------------------------------------------------        ######         ---
--       ######      ---------------------------------------------------------------------------        #######       -----
--       ######      --------------------------------------------------------------------------        #######        -----
--       ######      ------------------------------------------------------------------------         #######        ------
--       ######      ------------------------------------------------------------------------        #######        -------
--       ######      -----------------------------------------------------------------------        #######        --------
--       ######       --------------------------------------------------------------------         #######        ---------
---      ######       -------------------------------------------------------------------         #######        ----------
---      ######       ------------------------------------------------------------------         ######         -----------
---      ######          --------------------------------------------------------------         ######         ------------
---      ######                                                                                ######        --------------
---      ######                                                                               ######         --------------
---      ######                                                                              ######         ---------------
---      #######                                                                            ######         ----------------
---      ########                                                                          ######         -----------------
---      ########################################################################################        ------------------
----      ######################################################################################        -------------------
----      ####################################################################################         --------------------
-----      ##################################################################################         ---------------------
-----                       ############################################################             ----------------------
-----                                                                                               -----------------------
------                                                                                             ------------------------
-------                                                                                          --------------------------
--------                                                                                       ----------------------------
----------                                                                                  -------------------------------
----------------- ----- -------- -------------- ----------  ---------------------------------------------------------------
---------------------------------------------------------------------------------------------------------------------------
---------------------------------------------------------------------------------------------------------------------------
'''

class Bufish_Sheet(templates.Template_Sheet):

    def validator(self, target):
        if np.amin(target[:17,:12]) > 0:
            target[:17,:12] *= -.5
            print("REJECT", 1)
            return False
        if np.amin(target[:25,:2]) < 0:
            target[:25,:2] *= -.5
            print("REJECT", 2)
            return False
        if np.amin(target[:15,-15:]) < 0:
            target[:15,-15:] *= -.5
            print("REJECT", 3)
            return False
        if np.amin(target[2,:]) < 0:
            target[2,:] *= -.5
            print("REJECT", 4)
            return False
        if np.amin(target[-2,:]) < 0:
            target[-2,:] *= -.5
            print("REJECT", 5)
            return False
        return True

if __name__ == "__main__":
    sheet = Bufish_Sheet(
        "rflag,thin",
        sys.argv,
        templates.string_2_template(FLAG_ISH_50),
        templates.string_2_template(FLAG_ISH_SCAN, black=-2),
        0.700,
        0.450,
    )
    sheet.load_raw_image()
    sheet.load_proj50_image()
    sheet.match()
