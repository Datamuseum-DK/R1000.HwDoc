#!/usr/local/bin/python3.8
#
# NB: We strive to use y-x coordinate order to match numpy's convention

''' STEP 210: Locate And-ish, Or-ish and Inverter-ish elements '''

import sys

import numpy as np

import templates

import schematics as sch


AND_ISH_50 = '''
-------------------------
################ --------
###################------
---------------- ###-----
                   ##----
                    ##-- 
                    ## - 
                     ##- 
                     ##- 
                     -## 
                     -## 
                     -## 
'''

AND_ISH_SCAN = '''
               -------------          ------------------        ------------------         ------------------        ----------------------- ----
              -------------------  ------------------------------------------------- ------------------------------------------------------------
              ----------------------------------------------------------------------  -- --------------------------------------------------------
                                                                                                   -- -------------------------------------------
                                                                                                           --------------------------------------
                                                                                                              -----------------------------------
                                                                                                                 --------------------------------
                                                                                                                     ----------------------------
       ##                                                                                                               -------------------------
     #####################################################################################################               ------------------------
    ########################################################################################################               ----------------------
   ##########################################################################################################               ---------------------
   ###############################################################################################################           --------------------
   ########                                                                                           ################        -------------------
   ######                                                                                                ##############        ------------------
   #####                                                                                                   #############        -----------------
   #####                                                                                                     ############        ----------------
   #####                                                                                                          ########        ---------------
   #####                                                                                                            #######        --------------
   ####           - -                       ---------              ---------                      - -                 ######        -------------
   ####          --                        --------                 ---------                  -------                 ######        ------------
   ####         --                           -----                  -------                      ----------             ######        -----------
   ####         --                            --                     ----                         ------------           ######        ----------
   ####         -                                                     ---                         ---------------         ######        ---------
   ####                                                                                            ----------------        ######        --------
   ####                                                                                            -----------------       #######        -------
   ####                                                                                            ------------------       ########      -------
   ####                                                                                            -------------------       #######       ------
   ####                                                                                             -------------------       #######      ------
   ####                                                                                             --------------------       #######      -----
   ####                                                                                             --------------------       #######      -----
   ####                                                                                             ---------------------       #######      ----
   ####                                                                                             ----------------------      #######      ----
  #####                                                                                             -----------------------      ######       ---
  #####                                                                                             -----------------------      #######       --
  #####                                                                                             -----------------------       #######      --
  #####                                                                                             ------------------------      #######       -
  #####                                                                                             -------------------------      #######      -
  #####                                                                                             -------------------------       ######       
  #####                                                                                             --------------------------      #######      
  #####                                                                                             --------------------------      #######      
  #####                                                                                             --------------------------       #######     
   ####                                                                                             ---------------------------      #######     
   ####                                                                                            -----------------------------      #######    
   ####                                                                                            -----------------------------      #######    
   ####        -                                                                                   -----------------------------       ######    
   ####                                                                                            -----------------------------       #######   
   ####        -                                                                                   ------------------------------      #######   
   ####        --                                                                                 -------------------------------      #######   
   ####        --                                                                                 --------------------------------      ######   
   ####        ---                                                     --                        ---------------------------------      ######   
   ####        ----                          -                        ---                         --------------------------------      ######   
   ####        ----                          ---                      ---                         --------------------------------      #######  
   ####        -----                         ---                       --                         --------------------------------      #######  
   ####        -----                         ----                       -                          -------------------------------      #######  
   ####        -----                         ---                                                   -------------------------------       ######  
   ####        -----                         ---                                                   -------------------------------        #####  
   ####        -----                        ----                                                   -------------------------------        #####  
   ####        -----                        ----                                                   -------------------------------        ###### 
   ####        ----                         -----                                                  -------------------------------        ###### 
   ####        ----                         ----                                                    ------------------------------         ######
   ####        -----                         ----                                                  -------------------------------         ######
   ####        -----                         ---                        -                           ------------------------------         ######
   ####        ----                          ---                       --                           ------------------------------         ######
'''

class Andish_Sheet(templates.Template_Sheet):

    def validator(self, target):
        for y_pix in range(20,120,10):
            if np.amin(target[y_pix,75:]) > 0:
               target[y_pix,75:] *= -.5
               return False
            if np.amin(target[y_pix,:-75]) > 0:
               target[y_pix,:-75] *= -.5
               return False
        for x_pix in range(20,140,10):
            if np.amin(target[64:,x_pix]) > 0:
               target[64:,x_pix] *= -.5
               return False
            if np.amin(target[:64,x_pix]) > 0:
               target[:64,x_pix] *= -.5
               return False
        return True


if __name__ == "__main__":
    sheet = Andish_Sheet(
        "andish",
        sys.argv,
        templates.string_2_template(AND_ISH_50, reflect=True),
        templates.string_2_template(AND_ISH_SCAN, reflect=True, black=-2),
        0.500,
        0.230,
        #type_pix=(150, 150),
        #type_window=(80, 110),
        #type_list=("F00", "F02", "F10", "F20", "F30", "F38", "F40", "F37", "F133", "F1804"),
    )
    sheet.load_raw_image()
    sheet.load_proj50_image()
    sheet.match()
